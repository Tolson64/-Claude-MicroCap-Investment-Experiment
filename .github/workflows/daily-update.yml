name: 每日投资组合数据更新

# 每日北京时间下午4点（UTC时间上午8点）自动运行
on:
  schedule:
    - cron: '0 8 * * *'  # UTC 8:00 = 北京时间 16:00
  workflow_dispatch:  # 允许手动触发

jobs:
  update-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 运行数据更新脚本
      run: |
        python auto_update.py
        
    - name: 配置Git用户信息
      run: |
        git config --local user.email "claude.experiment@github-actions.com"
        git config --local user.name "Claude Investment Bot"
        
    - name: 检查是否有变更
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: 提交并推送变更
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git add .
        git commit -m "📈 自动更新投资组合数据 - $(date +'%Y-%m-%d %H:%M:%S') 北京时间

        🤖 Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push
        
    - name: 更新状态徽章
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "✅ 数据更新成功 - $(date +'%Y-%m-%d %H:%M:%S')"
      
    - name: 无变更提示
      if: steps.verify-changed-files.outputs.changed == 'false'
      run: |
        echo "ℹ️ 无数据变更，跳过提交"